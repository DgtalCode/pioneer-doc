Web-интерфейс для управления ESP32
==================================

ESP32 создает подсеть, в которой ей (ESP32) присваивается постоянный
адрес ``192.168.4.1``

.. contents::
    :depth: 1
    :local:

Информация о версии
-------------------

Запрос: ``http://192.168.4.1/info``.

Ответ: JSON вида.

.. code:: json

   ["0.2.8-59", "1.6.7481"]

Структура JSON-массива
~~~~~~~~~~~~~~~~~~~~~~

+----------+-----------------------------------------------------------------------------------+
| Позиция  | Описание                                                                          |
+==========+===================================================================================+
| ``[1]``  | Версия прошивки ESP32                                                             |
+----------+-----------------------------------------------------------------------------------+
| ``[2]``  | Версия прошивки платы, для которой ESP32 служит модулем связи                     |
|          | (вероятнее всего - плата автопилота)                                              |
|          |                                                                                   |
|          |**Ограничения:**                                                                   |
|          | - Может отсутствовать, если ESP32 не удалось получить информацию о версии         |
+----------+-----------------------------------------------------------------------------------+

Информация о состоянии
----------------------

Запрос.

.. code:: http

   http://192.168.4.1/control

В ответ страница присылает JSON с описанием текущего состояния коптера
вида:

.. code:: json

   {
       "video_record": false,
       "wifi_sta_connected": false,
       "wifi_sta_ip": [192, 168, 43, 6],
       "camera_frame_size":    [480, 320]
   }

Поля JSON-ответа
~~~~~~~~~~~~~~~~

+------------------+---------------------------------------------------+
| Поле             | Значение                                          |
+==================+===================================================+
| ``video_record`` | ``true`` - запись ведется ``false`` - запись не   |
| : bool           | ведется                                           |
+------------------+---------------------------------------------------+
| ``wifi_          | Флаг, обозначающий наличие подключения ESP32 к    |
| sta_connected``: | Wi-Fi Access Point                                |
| bool             |                                                   |
+------------------+---------------------------------------------------+
| ``wifi_sta_ip``: | IP адрес, присвоенный ESP32 WiFi Access Point в   |
| array(int)       | виде JSON-массива целочисленных значений. Виден   |
|                  | только в случае, если у ESP32 есть IP адрес в     |
|                  | сети WiFi Access Point                            |
+------------------+---------------------------------------------------+
| ``came           | Текущее разрешение камеры                         |
| ra_frame_size``: |                                                   |
| array(int)       |                                                   |
+------------------+---------------------------------------------------+

Управление состоянием - общие сведения
--------------------------------------

Управление производится отправкой *GET*-запросов вида:

.. code:: http

   http://192.168.4.1/control?ARGUMENTS...

В ответ на команды управления коптер присылает JSON вида:

.. code:: json

   {
       "video_record": false,
       "wifi_sta_connected": true,
       "wifi_sta_ip": [192, 168, 43, 6],
       "success":  false,
       "camera_frame_size":    [480, 320],
       "message":  "Wrong input argument(s)"
   }

Полученный JSON содержит инфромацию о результате выполнения команды.

Полученный JSON также содержит информацию об актуальном состоянии ESP32.

Структура полученного JSON’а справедлива для всех команд управления,
если не указано обратное.

.. _поля-json-ответа-1:

Поля JSON-ответа
~~~~~~~~~~~~~~~~

+--------------+-------------------------------------------------------+
| Поле         | Значение                                              |
+==============+=======================================================+
| ``success``: | ``true`` - команда выполнена успешно, \ ``false`` -   |
| bool         | команда не выполнена успешно                          |
+--------------+-------------------------------------------------------+
| ``message``: | Появляется в случае ``success: false``. Содержит      |
| string       | информацию о причине провала.                         |
+--------------+-------------------------------------------------------+

Запись видео
------------

Запуск
~~~~~~

Запрос:

.. code:: http

   http://192.168.4.1/control
       ?function=video_record
       &command=start
       &name=<FILE_NAME>

Параметры:

+-------+--------------------------------------------------------------+
| Пар   | Значение                                                     |
| аметр |                                                              |
+=======+==============================================================+
| ``na  | Имя сохраняемого файла\ **Ограничения:** - Максимальная      |
| me=`` | длина - 8 символов                                           |
+-------+--------------------------------------------------------------+

Остановка
~~~~~~~~~

Запрос:

.. code:: http

   http://192.168.4.1/control
       ?function=video_record
       &command=stop

Сохранение фото
---------------

Запрос:

.. code:: http

   http://192.168.4.1/control
       ?function=photo
       &name=<FILE_NAME>

Параметры:

+-------------------+--------------------------------------------------+
| Параметр          | Значение                                         |
+===================+==================================================+
| ``                | Имя сохраняемого файла \ **Ограничения:** -      |
| name=FILE_NAME``: | Максимальная длина - 8 символов                  |
| string            |                                                  |
+-------------------+--------------------------------------------------+

Изменение разрешения камеры
---------------------------

*Начиная с версии 1.0.0*

Установка нужного разрешения устанавливается выполнением запроса вида:

.. code:: http

   http://192.168.4.1/control
       ?function=camera_frame_size
       &width=480
       &height=320

Параметры
~~~~~~~~~

============================== =================================
Параметр                       Значение
============================== =================================
``function=camera_frame_size`` -
``width=WIDTH``                Размер изображения по горизонтали
``height=HEIGHT``              Размер изображения по вертикали
============================== =================================

Допустимые пары (WIDTH, HEIGHT)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-  (240, 240)
-  (320, 240)
-  (400, 296)
-  (480, 320)
-  (640, 480)

При попытке установить недопустимое разрешение будет сформирован JSON
вида:

.. code:: json

   {
       "video_record": false,
       "wifi_sta_connected":   false,
       "camera_frame_size":    [480, 320],
       "success":  false,
       "message":  "Value is out of range, or unacceptible"
   }

Wi-Fi Access Point
------------------

*Начиная с версии 0.4.0*

Подключение
~~~~~~~~~~~

Запрос. Явное указание IP адреса:

.. code:: http

   http://192.168.4.1/control
       ?function=wifi
       &command=connect
       &ssid=MyGildedCage
       &password=RagingHamster666
       &ip=10.0.0.42
       &gateway=10.0.0.1
       &netmask=255.255.255.0

Запрос. Без указания IP адреса. Предполагается, что в сети точки доступа
работает DHCP сервер

.. code:: http

   http://192.168.4.1/control
       ?function=wifi
       &command=connect
       &ssid=MyGildedCage
       &password=RagingHamster666

Для того чтобы сменить Wi-Fi сеть, вызывается та же команда. Явный сброс
соединения не требуется.

Отключение
~~~~~~~~~~

.. code:: http

   http://192.168.4.1/control
       ?function=wifi
       &command=disconnect

.. _параметры-1:

Параметры
~~~~~~~~~

+----------------------------------+-----------------------------------+
| Параметр                         | Значение                          |
+==================================+===================================+
| ``function=wifi``                | -                                 |
+----------------------------------+-----------------------------------+
| ``command=con                    | Подключиться к сетиОтключиться от |
| nect``\ \ ``command=disconnect`` | сети                              |
+----------------------------------+-----------------------------------+
| ``ssid=NAME``                    | ``NAME`` - Имя Wi-Fi сети         |
+----------------------------------+-----------------------------------+
| ``password=PASSWORD``            | ``PASSWORD`` - Пароль Wi-Fi сети  |
+----------------------------------+-----------------------------------+
| ``ip=IP``                        | ``IP`` Присваиваемый адрес        |
+----------------------------------+-----------------------------------+
| ``gateway=GATEWAY``              | ``GATEWAY`` - IP маршрутизатора   |
+----------------------------------+-----------------------------------+
| ``netmask=NETMASK``              | ``NETMASK`` - маска подсети       |
+----------------------------------+-----------------------------------+

Если хотя бы один параметр из ``ip``, ``gateway``, ``netmask`` (1) не
указан или (2) указан неверно (ошибка в формате), он будет
проигнорирован, и произойдет активация DHCP клиента. ESP32 будет искать
DHCP сервер, чтобы тот присвоил IP.
