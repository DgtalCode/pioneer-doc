Описание и настройка протокола Mailbox | Беспроводная передача сообщений
============================================================

Общее описание протокола
------------------------

Mailbox - это протокол передачи данных между устройствами в сети WI-FI. Данный протокол был впервые реализован в контроллерах
Трик, после чего получил поддержку со стороны квадрокоптеров Геоскан. Данные передаются побайтово в текстовом формате,
принцип работы очень похож на работу с серийным последовательным портом (Serial / UART).

У каждого устройства в сети "почтовых ящиков" есть свой борт-номер, устанавливаемый пользователем в программе на этом устройстве.
Борт-номер представляет собой целое число >0, оно должно быть уникальным для каждого устройства в сети.

.. image:: 1.png
    :align: center
    :width: 500

В сети нет главного устройства (отсутствует иерархия MASTER - SLAVES), каждый может общаться с каждым, однако это не
распределенная сеть, поскольку при выходе из строя точки доступа WI-Fi, передача данных будет нарушена.

Точкой доступа не обязательно должен быть WI-Fi роутер, в качестве точки доступа может быть одно из устройств, выспутающих
участниками сети обмена сообщениями, напрмер, квадрокоптер Геоскан Пионер Мини.

.. note:: Пионер Мини поддерживает лишь одно активное подключение по WI-FI, поэтому, если у вас обмениваться сообщениями должны больше двух устройств, то нужно перевести Мини в режим клиента и подключить к существующей WI-Fi сети (вашему роутеру, или, например, контроллеру Трик). Про подключение квадрокоптера к существующей сети можно почитать на странице `описания веб интерфейса. <../../../../instructions/pioneer-mini/settings/esp_webinterface.html>`__

После подключения минимум двух устройств к WI-FI сети они могут начать обмениваться данными, для этого одно из этих устройств
(и каждое новое подключающееся к WI-FI сети) должно зарегистрироваться в сети почтовых ящиков.
Это делается командой ``mailbox.connect(ip, port)`` (`см описание <../../../lua/sections/0009_mailbox.html#mailbox.connect>`__).

В момомент выполнения этой команды новое подключающееся устройство регистрируется в сети почтовых ящиков, но казалось бы,
судя по команде, подключение происходит только к одному устройству, назовем его D1. Дело в том, что когда устройство D1
получает сообщение о регистрации в сети от нового устройства, то D1 передает новому устройству таблицу со всеми известными
ему устройствами, которые уже были зарегистрированы в сети, таким образом, новое устройство узнает информацию о всех участниках
сети и может отправлять сообщения любому из них.

.. important:: После инициализации подключения, т.е. вызова команды ``mailbox.connect(ip, port)``, что со стороны Трик, что со стороны Пионер, для стабильной работы обязательно нужно ставить задержку (примерно 100мс), чтобы устройства успели обработать новые подключения.


Подготовка к использованию протокола
------------------------------------

Подготовка квадрокоптера
~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы начать использовать протокол mailbox с квадрокоптреами Пионер необходимо выполнить следующие действия:

#. Установить поддерживающие эту функцию `прошивки <https://disk.yandex.ru/d/Bs1QOpgg-w9Y7A>`__ автопилота и ESP32 по интрукциям: `для АП <../../../../instructions/pioneer-mini/settings/firmware_update.html>`__, `для ESP32 <../../../../instructions/pioneer-mini/settings/esp32-update.html>`__;
#. Ознакомиться с `документацией по API <../../../lua/sections/0009_mailbox.html>`__ протокола mailbox.

