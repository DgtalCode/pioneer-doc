Lua документация по API
===========================

.. contents:: Содержание:
   :depth: 1
   :local:
   :backlinks: none

.. highlight:: lua


События, отправляемые автопилоту
--------------------------------

События (events) представляются константами с префиксом "Ev."

+----------------+-------------------------------------------+
|    Название    |                  Описание                 |
+================+===========================================+
| MCE_PREFLIGHT  | Запустить двигатели и провести подготовку |
+----------------+-------------------------------------------+
| ENGINES_DISARM | Отключить двигатели                       |
+----------------+-------------------------------------------+
| MCE_LANDING    | Отправить на посадку                      |
+----------------+-------------------------------------------+
| MCE_TAKEOFF    | Отправить на взлет                        |
+----------------+-------------------------------------------+
| --устаревшие-- |                                           |
+----------------+-------------------------------------------+
| ENGINES_ARM    | Завести двигатели                         |
+----------------+-------------------------------------------+


События, принимаемые от автопилота
-----------------------------------

Доступны следующие события, приходящие от автопилота:

+--------------------+-----------------------------------------------------------+
|      Название      |                          Описание                         |
+====================+===========================================================+
| ENGINES_STARTED    | Двигатели запущены                                        |
+--------------------+-----------------------------------------------------------+
| COPTER_LANDED      | Коптер совершил посадку                                   |
+--------------------+-----------------------------------------------------------+
| TAKEOFF_COMPLETE   | Коптер достиг высоты взлета                               |
+--------------------+-----------------------------------------------------------+
| POINT_REACHED      | Коптер достиг точки                                       |
+--------------------+-----------------------------------------------------------+
| POINT_DECELERATION | Коптер начал тормозить при подлёте к точке                |
+--------------------+-----------------------------------------------------------+
| LOW_VOLTAGE1       | Низкое напряжение аккумулятора, для возвращения домой     |
+--------------------+-----------------------------------------------------------+
| LOW_VOLTAGE2       | Низкое напряжение аккумулятора, переходит в режим посадки |
+--------------------+-----------------------------------------------------------+
| SYNC_START         | Получен сигнал синхронного старта от системы навигации    |
+--------------------+-----------------------------------------------------------+
| SHOCK              | Столкновение или слишком сильные вибрации                 |
+--------------------+-----------------------------------------------------------+
| CONTROL_FAIL       | Угол наклона коптера превысил допустимый                  |
+--------------------+-----------------------------------------------------------+
| ENGINE_FAIL        | Отказ двигателя                                           |
+--------------------+-----------------------------------------------------------+

* событие Ev.ALTITUDE_REACHED ( коптер достиг высоты взлёта) начиная с версии АП 1.5.6173 более не используется.


Описание необходимых служебных функций скрипта
-----------------------------------------------

.. code:: lua

    function callback(event) -- Вызывается, когда приходят события от автопилота.
    end

Описание пинов разъемов модулей
-------------------------------

Пины МК АП на ``Pioneer_Base_v.1.0-v.1.1``, выведенные на внешние разъемы:

+--------------------+----------------------------+---------------------------+
| Разъем X1 (пин МК) | Функция                    | Описание                  |
+====================+============================+===========================+
| 1                  | Питание 5 В (только с АКБ) | Максимум 2 А              |
+--------------------+----------------------------+---------------------------+
| 2                  | Питание 3.3 В              | Максимум 2 А              |
+--------------------+----------------------------+---------------------------+
| 3 (PA12)           | USART1_RTS                 |                           |
+--------------------+----------------------------+---------------------------+
| 4 (PA11)           | USART1_CTS, TIM1_CH4       | Module_OpenMV             |
+--------------------+----------------------------+---------------------------+
| 5 (PA10)           | USART1_RX, TIM1_CH3        | Module_GPS, Module_USNav  |
+--------------------+----------------------------+---------------------------+
| 6 (PA9)            | USART1_TX, TIM1_CH2        | Module_GPS, Module_USNav  |
+--------------------+----------------------------+---------------------------+
| 7 (PA15)           | SPI3_NSS, TIM2_CH1         | Module_GPS, Module_OpenMV |
+--------------------+----------------------------+---------------------------+
| 8 (PC10)           | SPI3_SCK                   | Module_GPS, Module_OpenMV |
+--------------------+----------------------------+---------------------------+
| 9 (PC11)           | SPI3_MISO                  | Module_GPS, Module_OpenMV |
+--------------------+----------------------------+---------------------------+
| 10 (PB5)           | SPI3_MOSI, TIM3_CH2        | Module_GPS, Module_OpenMV |
+--------------------+----------------------------+---------------------------+
| 11                 | Земля                      |                           |
+--------------------+----------------------------+---------------------------+
| 12                 | Земля                      |                           |
+--------------------+----------------------------+---------------------------+

|

+--------------------+------------------------------+------------------------------+
| Разъем X2 (пин МК) | Функция                      | Описание                     |
+====================+==============================+==============================+
| 1                  | Питание 5 В (только с АКБ)   | Максимум 2 А                 |
+--------------------+------------------------------+------------------------------+
| 2                  | Питание 3.3 В                | Максимум 2 А                 |
+--------------------+------------------------------+------------------------------+
| 3 (PC2)            | ADCx_IN12                    |                              |
+--------------------+------------------------------+------------------------------+
| 4 (PC3)            | ADCx_IN13                    |                              |
+--------------------+------------------------------+------------------------------+
| 5 (PA1)            | ADCx_IN1, TIM2_CH2, TIM5_CH2 | Module_Cargo (упр. магнитом) |
+--------------------+------------------------------+------------------------------+
| 6 (PB7)            | I2C1_SDA, TIM4_CH2           | Module_ToF, Module_OpenMV    |
+--------------------+------------------------------+------------------------------+
| 7 (PB6)            | I2C1_SCL, TIM4_CH1           | Module_ToF, Module_OpenMV    |
+--------------------+------------------------------+------------------------------+
| 8 (PA0)            | DATA WS2812B                 | Уровень 5 В. Module_LED      |
+--------------------+------------------------------+------------------------------+
| 9                  | Земля                        |                              |
+--------------------+------------------------------+------------------------------+
| 10                 | Земля                        |                              |
+--------------------+------------------------------+------------------------------+

Для ``Pioneer_Base_v.1.2``:

+--------------------+-----------------------------------------+------------------------------+
| Разъем X2 (пин МК) |                 Функция                 |           Описание           |
+====================+=========================================+==============================+
| 3 (PA0)            | USART4_TX, ADCx_IN0, TIM2_CH1, TIM5_CH1 | Module_OpenMV                |
+--------------------+-----------------------------------------+------------------------------+
| 4 (PA1)            | USART4_RX, ADCx_IN1, TIM2_CH2, TIM5_CH2 | Module_OpenMV                |
+--------------------+-----------------------------------------+------------------------------+
| 5 (PС3)            | ADCx_IN13, SPI2_MOSI                    | Module_Cargo (упр. магнитом) |
+--------------------+-----------------------------------------+------------------------------+
| 8 (PC12)           | DATA WS2812B                            | Уровень 5 В. Module_LED      |
+--------------------+-----------------------------------------+------------------------------+


Описание программных объектов
-----------------------------

.. toctree::
   :maxdepth: 1
   :glob:

   sections/*